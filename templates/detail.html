{% extends "base.html" %}
{% block title %}Chi tiết ứng viên{% endblock %}

{% block content %}
<div class="card"
    style="max-width: 820px; margin: 32px auto; padding: 32px; background: #1e1e2f; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); font-size: 1rem;">
    <!-- Tiêu đề -->
    <h2 style="color:#4FC3F7; margin-bottom: 24px; display: flex; align-items: center;">
        📄 <span style="margin-left: 10px;">Chi tiết ứng viên</span>
    </h2>

    {% if cv.get('PDFPath') %}
    <p style="margin-bottom: 24px;">
        📥 <a href="{{ url_for('hr.download_file', filename=cv['PDFPath'].split('/')[-1]) }}" download
            style="color:#90CAF9; text-decoration:underline;">
            Tải file CV (PDF)
        </a>
    </p>
    {% endif %}

    <!-- Thông tin cá nhân -->
    <div style="background:#23272f; padding: 20px; border-radius: 10px; margin-bottom: 24px;">
        <h3 style="color:#FFD54F; margin-bottom: 12px;">👤 Thông tin ứng viên</h3>
        <p><b style="color:#90CAF9;">📛 Họ tên:</b> {{ cv.full_name }}</p>
        <p><b style="color:#FFD54F;">📧 Email:</b> {{ cv.email }}</p>
        <p><b style="color:#4FC3F7;">📱 SĐT:</b> {{ cv.phone }}</p>
        <p><b style="color:#FFD54F;">💼 Vị trí gần nhất:</b> {{ cv.last_job_title }}</p>
        <p><b style="color:#4FC3F7;">⏳ Kinh nghiệm:</b> {{ cv.experience }} năm</p>
        <p><b style="color:#FFD54F;">🏠 Địa chỉ:</b> {{ cv.home_address }}</p>
        {% if cv.github or cv.linkedin %}

        {% if cv.github %}
        <p><b style="color:#90CAF9;">🐙 GitHub:</b>
            <a href="{{ cv.github }}" target="_blank" style="color:#4FC3F7;">{{ cv.github }}</a>
        </p>
        {% endif %}
        {% if cv.linkedin %}
        <p><b style="color:#FFD54F;">🔗 LinkedIn:</b>
            <a href="{{ cv.linkedin }}" target="_blank" style="color:#FFD54F;">{{ cv.linkedin }}</a>
        </p>
        {% endif %}

        {% endif %}
    </div>
    <!-- GitHub / LinkedIn -->


    <!-- Kỹ năng và công cụ dạng pill -->
    <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 24px;">
        <div style="flex:1; background:#2a2d3a; padding: 16px; border-radius: 10px;">
            <h4 style="color:#FFD54F;">💡 Kỹ năng</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                {% for skill in cv.skills %}
                <span
                    style="background:#4FC3F7; color:#000; padding:4px 10px; border-radius:16px; font-size:0.85rem; font-weight:500;">
                    {{ skill }}
                </span>
                {% endfor %}
            </div>
        </div>
        <div style="flex:1; background:#2a2d3a; padding: 16px; border-radius: 10px;">
            <h4 style="color:#81C784;">⚙️ Công cụ</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                {% for tool in cv.tools %}
                <span
                    style="background:#FFD54F; color:#000; padding:4px 10px; border-radius:16px; font-size:0.85rem; font-weight:500;">
                    {{ tool }}
                </span>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Học vấn -->
    <div style="background:#23272f; padding: 20px; border-radius: 10px; margin-bottom: 24px;">
        <h3 style="color:#FFD54F;">🎓 Học vấn</h3>
        {% if cv.education %}
        <ul style="padding-left: 20px;">
            {% for edu in cv.education %}
            <li>
                {% if edu.Degree %}<b>{{ edu.Degree }}</b> - {% endif %}{{ edu.Institution }}
                {% if edu.GraduationYear %} ({{ edu.GraduationYear }}){% endif %}
                {% if edu.GPA %} - GPA: {{ edu.GPA }}{% endif %}
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p>Không có thông tin học vấn.</p>
        {% endif %}
    </div>

    <!-- Gợi ý ngành nghề -->
    <div style="margin-bottom: 24px;">
        <h3 style="color:#4FC3F7;">🧠 Gợi ý ngành nghề</h3>
        <form method="POST" style="margin-bottom: 12px;">
            <input type="hidden" name="action" value="predict_category">
            <button type="button" onclick="submitPredictCategory('{{ cv._id }}')"
                style="background: linear-gradient(90deg,#1976D2 60%,#4FC3F7 100%); color:#fff; border:none; padding:8px 20px; border-radius:6px; font-weight:600;">
                📊 Phân loại ngành nghề
            </button>
            <p id="predict-result" style="margin-top: 10px;"></p>
        </form>
        {% if predicted_job %}
        <div style="background:#2e3340; border-left: 4px solid #FFD54F; padding: 12px; border-radius: 6px;">
            <p>✅ <b style="color:#FFD54F;">Gợi ý:</b> <strong>{{ predicted_job }}</strong></p>
        </div>
        {% endif %}
    </div>

    <!-- So khớp JD -->
    <div style="margin-bottom: 24px;">
        <h3 style="color:#4FC3F7;">📝 So khớp JD với CV</h3>
        <form method="POST">
            <input type="hidden" name="action" value="jd_match">
            <textarea id="jd_text"  name="jd_text" placeholder="Nhập mô tả công việc..." rows="5" style="width:100%; background:#181A20; color:#EDEDED;
                   border:1px solid #444; border-radius:6px;
                   padding:10px; margin-bottom:10px;">{{ request.form.get('jd_text', '') }}</textarea>
            <button type="submit" onclick="submitJDMatch('{{ cv._id }}')" style="background: linear-gradient(90deg,#1976D2 60%,#4FC3F7 100%);
                   color:#fff; border:none; padding:8px 20px;
                   border-radius:6px; font-weight:600;">
                ⚙️ So khớp JD
            </button>
            <div id="jd-result" style="margin-top: 12px;"></div>
        </form>
        {% if jd_result %}
        <div style="background:#2e3340; border-left: 4px solid #FFD54F; padding: 16px; border-radius: 6px;">
            <p><b style="color:#4FC3F7;">🎯 Điểm phù hợp:</b> {{ jd_result.MatchingScore }}/10</p>
            <p><b style="color:#FFD54F;">💬 Lý do:</b> {{ jd_result.Reason }}</p>
        </div>
        {% endif %}
    </div>


    <!-- Quay lại -->
    <div style="margin-top: 24px; text-align: right;">
        <a href="{{ url_for('hr.clear_detail_session') }}"
            style="background: linear-gradient(90deg,#1976D2 60%,#4FC3F7 100%); color: #fff; padding: 8px 20px; border-radius: 6px; font-weight: 600; text-decoration: none;">
            ⬅ Quay lại danh sách
        </a>

    </div>
</div>


<script>
    async function submitPredictCategory(cvId) {
        const btn = event.target;
        btn.disabled = true;
        const originalText = btn.innerHTML;
        btn.innerHTML = "⏳ Đang phân loại...";

        const res = await fetch(`/hr/api/predict_category/${cvId}`, {
            method: "POST"
        });

        const data = await res.json();
        document.getElementById("predict-result").innerHTML =
            `✅ <b style="color:#FFD54F;">Gợi ý:</b> <strong>${data.predicted_job}</strong>`;

        btn.disabled = false;
        btn.innerHTML = originalText;
    }

    async function submitJDMatch(cvId) {
        const btn = event.target;
        const jdText = document.getElementById("jd_text").value;

        if (!jdText.trim()) {
            alert("❗ Vui lòng nhập mô tả công việc trước khi so khớp.");
            return;
        }

        btn.disabled = true;
        const originalText = btn.innerHTML;
        btn.innerHTML = "⏳ Đang so khớp...";

        const res = await fetch(`/hr/api/jd_match/${cvId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ jd_text: jdText })
        });

        const data = await res.json();
        document.getElementById("jd-result").innerHTML = `
            <div style="background:#2e3340; border-left: 4px solid #FFD54F; padding: 16px; border-radius: 6px;">
                <p><b style="color:#4FC3F7;">🎯 Điểm phù hợp:</b> ${data.MatchingScore}/10</p>
                <p><b style="color:#FFD54F;">💬 Lý do:</b> ${data.Reason}</p>
            </div>
        `;

        btn.disabled = false;
        btn.innerHTML = originalText;
    }
</script>

{% endblock %}